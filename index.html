<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jquery-3.7.1.min.js"></script>
    <title>Physics Simulator</title>
</head>

<style>
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        padding: 20px;
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
    }

    button {
        font-family: inherit;
        font-weight: inherit;
    }

    input {
        font-family: inherit;
        font-weight: inherit;
        padding: 5px 10px;
        border: 2px solid #498298;
        border-radius: 5px;
        background-color: #ffffff;
        transition: border-color 0.3s, box-shadow 0.3s;
    }


    input[type="color"] {
        padding: 2px;
        width: 50px;
        height: 30px;
    }

    select {
        font-family: inherit;
        font-weight: inherit;
        padding: 5px 10px;
        border: 2px solid #498298;
        border-radius: 5px;
        background-color: #ffffff;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .menu-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 20px;
        padding: 20px;
        border-radius: 10px;
        background-color: #81dbff;
        border: 4px solid #498298;
    }

    .menu-container button {
        padding: 10px 20px;
        border-radius: 5px;
        border: 2px solid rgb(0, 0, 0);
        background-color: #ffffff;
    }

    .menu-container button:hover {
        background-color: #faff6f;
    }

    .menu-subsection {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .particles-container {
        display: none;
        flex-direction: column;
        gap: 10px;
        position: fixed;
        top: 20px;
        left: 20px;
    }

    .particles-container.show {
        display: flex;
    }

    .particles-container button {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 2px solid black;
        background-color: #f82828;
    }

    .particles-container button.active {
        box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.5);
        transform: scale(1.1);
    }

    .edit-particles-container {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: fixed;
        top: 300px;
        left: 50%;
        transform: translateX(-50%);
    }

    .edit-particles-container.show {
        display: flex;
    }

    .edit-particles-container div {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 10px;
        background-color: #caffd1;
        border: 2px solid rgb(0, 90, 11);
        border-radius: 10px;
    }

    .edit-particles-container .particle-icon {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid black;
        background-color: #f82828;
    }

    .edit-force-select-cell {
        width: 80px;
        height: 40px;
        display: flex;
        flex-direction: column;
    }

    canvas {
        border: 4px solid black;
        border-radius: 10px;
        width: 600px;
        height: 600px;
    }



</style>

<body>
    <div class="menu-container">
        <button id="add-particles">Add particles</button>
        <button id="edit-particles">Edit particles</button>
        <button id="edit-particle-properties">Edit properties</button>
        <button id="edit-forces">Edit forces</button>
    </div>

    <div class="menu-container particles-container" id="particles-container"></div>
    <div class="menu-container edit-particles-container" id="edit-particles-container"></div>

    <div class="menu-container edit-particles-container" id="new-particle-container">
        <input type="text" id="new-particle-name" placeholder="Particle name">
        <input type="number" id="new-particle-mass" placeholder="Particle mass">
        <input type="color" id="new-particle-color" placeholder="Particle color">
        <input type="number" id="new-particle-radius" placeholder="Particle radius">
        <button id="create-new-particle">Create new particle</button>
    </div>

    <div class="menu-container edit-particles-container" id="edit-particle-properties-container">
        <select id="particle-select">
            <option value="">Select a particle</option>
        </select>
        <select id="property-select">
            <option value="">Select a property</option>
        </select>
        <input type="number" id="property-value" placeholder="Enter value">
        <button id="update-particle-property">Update Property</button>
    </div>

    <div class="menu-container edit-particles-container" id="edit-forces-container">
        <select id="property-select-force-edit">
            <option value="">Select a property</option>
        </select>
        <select id="force-select">
            <option value="">Select a force</option>
        </select>
        <p>F(r=0)</p>
        <input type="number" id="strength-value" placeholder="Enter value">
        <p>r(F=0)</p>
        <input type="number" id="range-value" placeholder="Enter value">
        <button id="update-property-force">Update Force</button>
    </div>



    <canvas id="simulation-canvas" width="600" height="600"></canvas>








    <script>






    //***CANVAS***

    const canvas = document.getElementById('simulation-canvas');
    const ctx = canvas.getContext('2d');
    let particle_can_be_added = false;
    let canvas_particles = [];

    canvas.addEventListener('click', (event) => {
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    console.log(x)
    console.log(y)
    if (particle_can_be_added) {
        add_particle_to_canvas_particles(x,y)
    }
    
    

    });

    function add_particle_to_canvas_particles(x, y) {
        canvas_particles.push({
            props: active_particle, 
            worldX: x, 
            worldY: y, 
            velX: 0, 
            velY: 0, 
            accX: 0, 
            accY: 0, 
            fixed: false});
    }

    function draw_canvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (const particle of canvas_particles) {
            ctx.beginPath();
            ctx.fillStyle = particle.props.color;
            ctx.arc(particle.worldX, particle.worldY, particle.props.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.closePath();
        }
    }











//***PHYSICS***

    // Define the arrays

    
    const dt = 0.1

    let properties = ["mass", "charge"];
    let forces = ["gravity", "electric"];
    let particles = [
        {name: "proton", 
        mass: 1, 
        color: 'rgb(255,100,100)',
        radius: 10}, 

        {name: "electron", 
        mass: 1, 
        color: 'rgb(100,100,255)',
        radius: 6}
    ];
    let active_particle = particles[0];



    // Create particle_properties object
    let particle_properties = {};
    for (const particle of particles) {
        for (const prop of properties) {
            particle_properties[`${particle.name},${prop}`] = 0.0;
        }
    }

    particle_properties["proton,charge"] = 1.0
    particle_properties["electron,charge"] = -1.0



    // Create property_forces object
    let property_forces = {};
    for (const prop of properties) {
        for (const force of forces) {
            property_forces[`${prop},${force}`] = [0,0]; // force for distance 0, distance where force is 0.
        }
    }

    property_forces["charge,electric"] = [-1, 200]




    function distance_between_particles(p1, p2) {
        let r = Math.sqrt(Math.pow((p1.worldX - p2.worldX), 2) + Math.pow((p1.worldY - p2.worldY), 2))
        return r
    }

    function vector_from_to(p1, p2) {     
        let vector = [p2.worldX - p1.worldX, p2.worldY - p1.worldY]
        return vector
    }

    function unit_vector_from_to(p1, p2) {
        let vector = vector_from_to(p1, p2)
        let r = distance_between_particles(p1, p2)
        let unit_vector = [vector[0]/r, vector[1]/r]
        return unit_vector
    }

    function acceleration_from_another_particles_on_particle(p1, p2) {
        let total_acc = [0,0]
        const unit_vector = unit_vector_from_to(p1, p2) 
        const r = distance_between_particles(p1, p2)
        for (force of forces) {
            for (prop of properties) {
                const force_value = property_forces[`${prop},${force}`]
                if (r < force_value[1]) {
                    const force_magnitude = parseFloat((force_value[0] * particle_properties[`${p1.props.name},${prop}`] * particle_properties[`${p2.props.name},${prop}`] * (force_value[1]-r) / force_value[1]).toFixed(4))
                    console.log("force_magnitude", force_magnitude)
                    const acc_magnitude = parseFloat((force_magnitude / p1.props.mass).toFixed(4))
                    total_acc[0] += parseFloat((unit_vector[0] * acc_magnitude).toFixed(4))
                    total_acc[1] += parseFloat((unit_vector[1] * acc_magnitude).toFixed(4))
                }

            }
        }
        return total_acc;
    }

    function acceleration_from_all_particles_on_particle(p1) {
        let total_acc = [0,0]
        for (const p2 of canvas_particles) {
            if (p1 !== p2) {
                const acc = acceleration_from_another_particles_on_particle(p1, p2)
                total_acc[0] += acc[0]
                total_acc[1] += acc[1]
            }
        }
        return total_acc
    }

    function update_accelerations() {
        for (const p of canvas_particles) {
            p.accX = acceleration_from_all_particles_on_particle(p)[0]
            p.accY = acceleration_from_all_particles_on_particle(p)[1]
        }
    }

    function update_velocities() {
        for (const p of canvas_particles) {
            p.velX = parseFloat((p.velX + p.accX * dt).toFixed(4))
            p.velY = parseFloat((p.velY + p.accY * dt).toFixed(4))
        }
    }

    function update_positions() {
        for (const p of canvas_particles) {
            p.worldX = parseFloat((p.worldX + p.velX * dt).toFixed(2))
            p.worldY = parseFloat((p.worldY + p.velY * dt).toFixed(2))
        }
    }

    function update_particles() {
        update_accelerations()
        update_velocities()
        update_positions()
    }






    //***MAIL LOOP***

    window.onload = function() {
        setInterval(update_particles, 50)
        setInterval(draw_canvas, 50)
    }










    //***MENU***

    //Toggle Add particles menu
    document.getElementById("add-particles").addEventListener("click", function() {
        const particlesContainer = document.getElementById("particles-container");
        particlesContainer.classList.toggle("show");
        particle_can_be_added = !particle_can_be_added;
        particlesContainer.innerHTML = "";
        
        for (const particle of particles) {
            const button = document.createElement("button");
            button.id = `button-${particle}`;
            button.textContent = particle.name;
            button.style.backgroundColor = particle.color;
            
            if (particle === active_particle) {
                button.classList.add("active");
                console.log("active particle: ", particle);
            }
            
            particlesContainer.appendChild(button);
        }
    });

    //Toggle Edit particles menu
    document.getElementById("edit-particles").addEventListener("click", function() {
        const editParticlesContainer = document.getElementById("edit-particles-container");
        editParticlesContainer.classList.toggle("show");
        editParticlesContainer.innerHTML = "";

        for (const particle of particles) {
            const div = document.createElement("div");
            div.id = `div-${particle}`;
            const particleIcon = document.createElement("div");
            particleIcon.classList.add("particle-icon");
            particleIcon.style.backgroundColor = particle.color;
            div.appendChild(particleIcon);
            div.appendChild(document.createTextNode(particle.name + ": m= " + particle.mass));
            editParticlesContainer.appendChild(div);
        }
        new_particle_button = document.createElement("button");
        new_particle_button.id = "new-particle-button";
        new_particle_button.textContent = "New particle";
        editParticlesContainer.appendChild(new_particle_button);

        const new_particle_container = document.getElementById("new-particle-container");
        new_particle_container.classList.remove("show");
    });

    //Toggle New particle menu
    document.getElementById("edit-particles-container").addEventListener("click", function(event) {
        if (event.target.id === "new-particle-button") {
            const newParticleContainer = document.getElementById("new-particle-container");
            newParticleContainer.classList.toggle("show");
        }
    });

    //Adding new particle through menu
    document.getElementById("new-particle-container").addEventListener("click", function(event) {
        if (event.target.id === "create-new-particle") {
            const name = document.getElementById("new-particle-name").value;
            const mass = parseFloat(document.getElementById("new-particle-mass").value);
            const color = document.getElementById("new-particle-color").value;
            const radius = parseFloat(document.getElementById("new-particle-radius").value);

            if (name && !isNaN(mass) && color && !isNaN(radius)) {
                const newParticle = {
                    name: name,
                    mass: mass,
                    color: color,
                    radius: radius
                };
                particles.push(newParticle);
                for (const prop of properties) {
                    particle_properties[`${name},${prop}`] = 0.0;
                }
                console.log("New particle created:", newParticle);
                
                // Clear input fields
                document.getElementById("new-particle-name").value = "";
                document.getElementById("new-particle-mass").value = "";
                document.getElementById("new-particle-color").value = "#000000";
                document.getElementById("new-particle-radius").value = "";
                
                // Hide the new particle container
                document.getElementById("new-particle-container").classList.remove("show");
                
                // Refresh the edit particles menu to show the new particle
                document.getElementById("edit-particles").click();
            } else {
                alert("Please fill all fields with valid values.");
            }
        }
    });

    //Toggle Edit particle properties menu and editing particle properties
    document.getElementById("edit-particle-properties").addEventListener("click", function() {
        const editParticlePropertiesContainer = document.getElementById("edit-particle-properties-container");
        editParticlePropertiesContainer.classList.toggle("show");
        
        // Populate particle selector
        const particleSelector = document.getElementById("particle-select");
        particleSelector.innerHTML = "<option value=''>Select a particle</option>"; // Clear existing options
        particles.forEach(particle => {
            const option = document.createElement("option");
            option.value = particle.name;
            option.textContent = particle.name;
            particleSelector.appendChild(option);
        });

        // Populate property selector
        const propertySelector = document.getElementById("property-select");
        propertySelector.innerHTML = "<option value=''>Select a property</option>"; // Clear existing options
        properties.forEach(property => {
            const option = document.createElement("option");
            option.value = property;
            option.textContent = property;
            propertySelector.appendChild(option);
        });

        // Show property value when selections change
        particleSelector.addEventListener("change", showCurrentValue);
        propertySelector.addEventListener("change", showCurrentValue);

        function showCurrentValue() {
            const selectedParticle = particleSelector.value;
            const selectedProperty = propertySelector.value;
            const propertyValueInput = document.getElementById("property-value");
            
            if (selectedParticle && selectedProperty) {
                const propertyKey = `${selectedParticle},${selectedProperty}`;
                propertyValueInput.value = particle_properties[propertyKey] || 0;
            } else {
                propertyValueInput.value = "";
            }
        }

        // Initial display
        showCurrentValue();


        //Update property value
        document.getElementById("update-particle-property").addEventListener("click", function() {
            const selectedParticle = particleSelector.value;
            const selectedProperty = propertySelector.value;
            const propertyValue = parseFloat(document.getElementById("property-value").value);
            const propertyKey = `${selectedParticle},${selectedProperty}`;
            particle_properties[propertyKey] = propertyValue;            
        });
    });




    document.getElementById("edit-forces").addEventListener("click", function() {

        const editForcesContainer = document.getElementById("edit-forces-container");
        editForcesContainer.classList.toggle("show");


        // Populate property selector
        const propertySelector = document.getElementById("property-select-force-edit");
        propertySelector.innerHTML = "<option value=''>Select a property</option>"; // Clear existing options
        properties.forEach(property => {
            const option = document.createElement("option");
            option.value = property;
            option.textContent = property;
            propertySelector.appendChild(option);
        });

        // Populate force selector
        const forceSelector = document.getElementById("force-select");
        forceSelector.innerHTML = "<option value=''>Select a force</option>"; // Clear existing options
        forces.forEach(force => {
            const option = document.createElement("option");
            option.value = force;
            option.textContent = force;
            forceSelector.appendChild(option);
        });



        // Show property value when selections change
        forceSelector.addEventListener("change", showCurrentValue);
        propertySelector.addEventListener("change", showCurrentValue);

        function showCurrentValue() {
            const selectedProperty = propertySelector.value;
            const selectedForce = forceSelector.value;
            const strengthValueInput = document.getElementById("strength-value");
            const rangeValueInput = document.getElementById("range-value");
            
            if (selectedForce && selectedProperty) {
                const propertyKey = `${selectedProperty},${selectedForce}`;
                strengthValueInput.value = property_forces[propertyKey][0] || 0;
                rangeValueInput.value = property_forces[propertyKey][1] || 0;
            } else {
                strengthValueInput.value = "";
                rangeValueInput.value = "";
            }
        }

        // Initial display
        showCurrentValue();


        //Update property value
        document.getElementById("update-property-force").addEventListener("click", function() {
            const selectedForce = forceSelector.value;
            const selectedProperty = propertySelector.value;
            const strengthValue = parseFloat(document.getElementById("strength-value").value);
            const rangeValue = parseFloat(document.getElementById("range-value").value);
            const propertyKey = `${selectedProperty},${selectedForce}`;
            property_forces[propertyKey] = [strengthValue, rangeValue];            
        });

        // for (const prop of properties) {
        //     const rowDiv = document.createElement("div")
        //     const propName = document.createElement("p")
        //     propName.innerText = prop
        //     rowDiv.appendChild(propName)
        //     for (const force of forces) {
        //         const editDiv = document.createElement("div")
        //         editDiv.classList.add("edit-force-select-cell")
        //         editDiv.innerHTML = '<p>F(r=0)</p><input type="number" id="strength-`${prop}`-`${force}`"><p>r(F=0)</p><input type="number" id="range-`${prop}`-`${force}`">'
        //         rowDiv.appendChild(editDiv)
        //     }
        //     editForcesContainer.appendChild(rowDiv)
        // }


    })

    //Select active particle
    document.getElementById("particles-container").addEventListener("click", function(event) {
        if (event.target.tagName === "BUTTON") {
            document.querySelectorAll("#particles-container button").forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            for ( const particle of particles) {
                if (particle.name === event.target.textContent) {
                    active_particle = particle;
                }
            }
            
            console.log("active particle: ", active_particle);
        }
    });



    </script>

</body>
</html>
